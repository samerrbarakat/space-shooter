<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Game Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
  <style>
    body{font-family:Arial;margin:20px}
    .cards{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:20px}
    .card{padding:12px 16px;border:1px solid #ddd;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .grid{display:grid;grid-template-columns:1fr;gap:24px}
    @media(min-width:1000px){.grid{grid-template-columns:1fr 1fr}}
    canvas{max-width:100%;height:360px}
    table{border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #eee;padding:6px 10px;text-align:left}
  </style>
</head>
<body>
  <h1>Game Analytics</h1>

  <div class="cards">
    <div class="card">Sessions: <b>{{ totals.sessions }}</b></div>
    <div class="card">Avg Score: <b>{{ totals.avg_score }}</b></div>
    <div class="card">Max Score: <b>{{ totals.max_score }}</b></div>
    <div class="card">Avg Duration (s): <b>{{ totals.avg_duration_s }}</b></div>
    <div class="card">Games in Last Hour: <b id="lastHour">{{ last_hour_cnt }}</b></div>
    <div class="card">Unique Players (all-time): <b>{{ unique_players }}</b></div>
    <div class="card">Unique Players (24h): <b>{{ unique_players_24h }}</b></div>
  </div>

  <div class="grid">
    <div>
      <h3>Sessions — last 24 hours (per hour)</h3>
      <canvas id="c24"></canvas>
    </div>
    <div>
      <h3>Peak hours — last 30 days (hour-of-day)</h3>
      <canvas id="chod"></canvas>
    </div>
  </div>

  <h3>Top scores</h3>
  <table>
    <tr><th>Score</th><th>When</th></tr>
    {% for row in top_scores %}
      <tr><td>{{ row.score }}</td><td>{{ row.started_at }}</td></tr>
    {% empty %}
      <tr><td colspan="2">No data yet</td></tr>
    {% endfor %}
  </table>
    {% load static %}
    <!-- Safely embed JSON payloads -->
    {{ ts24|json_script:"ts24-data" }}
    {{ hod|json_script:"hod-data" }}

    <script>
    // Parse back into JS
    const ts24 = JSON.parse(document.getElementById('ts24-data').textContent);
    const hod  = JSON.parse(document.getElementById('hod-data').textContent);

    (function () {
        const labels = ts24.map(d => new Date(d.h));      // h is ISO string
        const counts = ts24.map(d => d.cnt);
        const avg    = ts24.map(d => d.avg_score);
        new Chart(document.getElementById('c24'), {
        type: 'line',
        data: { labels, datasets: [
            { label: 'Sessions', data: counts, yAxisID: 'y1' },
            { label: 'Avg Score', data: avg,    yAxisID: 'y2' },
        ]},
        options: {
            scales: {
            x: { type: 'time', time: { unit: 'hour' } },
            y1:{ type:'linear', position:'left' },
            y2:{ type:'linear', position:'right', grid:{ drawOnChartArea:false } }
            }
        }
        });
    })();

    (function () {
        const labels = hod.map(d => d.h);
        const counts = hod.map(d => d.cnt);
        new Chart(document.getElementById('chod'), {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Sessions by hour (last 30d)', data: counts }] },
        options: { scales: { y: { beginAtZero: true } } }
        });
    })();
    </script>
</body>
</html>
